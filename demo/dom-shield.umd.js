(function(e,t){typeof exports==`object`&&typeof module<`u`?t(exports):typeof define==`function`&&define.amd?define([`exports`],t):(e=typeof globalThis<`u`?globalThis:e||self,t(e.DOMShield={}))})(this,function(exports){Object.defineProperty(exports,`__esModule`,{value:!0});var t=class e{id;violationData;timestamp;userAgent;url;additionalInfo;constructor(e,t,n=new Date,r=navigator.userAgent,i=window.location.href,a={}){this.id=e,this.violationData=t,this.timestamp=n,this.userAgent=r,this.url=i,this.additionalInfo=a}equals(t){return t instanceof e?this.id===t.id:!1}isHighRisk(){return this.violationData.violatedDirective.includes(`script-src`)||this.violationData.violatedDirective.includes(`object-src`)||this.violationData.violatedDirective.includes(`base-uri`)}getRiskLevel(){return this.isHighRisk()?`high`:this.violationData.violatedDirective.includes(`style-src`)||this.violationData.violatedDirective.includes(`img-src`)?`medium`:`low`}getViolationSummary(){return`Violation: ${this.violationData.violatedDirective} - Blocked: ${this.violationData.blockedUri}`}},n=class e{id;policyData;createdAt;updatedAt;constructor(e,t,n=new Date,r=new Date){this.id=e,this.policyData=t,this.createdAt=n,this.updatedAt=r}equals(t){return t instanceof e?this.id===t.id:!1}hasDirective(e){return this.policyData.directives.some(t=>t.name===e)}getDirectiveValue(e){return this.policyData.directives.find(t=>t.name===e)?.value}isSecure(){return this.policyData.isCompliant&&this.hasDirective(`default-src`)&&this.hasDirective(`script-src`)}getSecurityScore(){let e=0;return[`default-src`,`script-src`,`style-src`,`img-src`].forEach(t=>{this.hasDirective(t)&&(e+=25)}),this.policyData.isCompliant&&(e+=10),Math.min(e,100)}},r=class e{_value;constructor(e){if(!e||e.trim().length===0)throw Error(`Endpoint cannot be empty`);let t=e.trim();if(!this.isValidEndpoint(t))throw Error(`Invalid endpoint format: ${t}`);this._value=t}get value(){return this._value}equals(t){return t instanceof e?this._value===t._value:!1}isValidEndpoint(e){try{return new URL(e,window.location.origin),!0}catch{return e.startsWith(`/`)}}isRelative(){return this._value.startsWith(`/`)}isAbsolute(){return this._value.startsWith(`http://`)||this._value.startsWith(`https://`)}toString(){return this._value}},i=class e{_name;_value;constructor(e,t){if(!e||e.trim().length===0)throw Error(`Directive name cannot be empty`);this._name=e.trim(),this._value=t||``}get name(){return this._name}get value(){return this._value}equals(t){return t instanceof e?this._name===t._name&&this._value===t._value:!1}isRequired(){return[`default-src`,`script-src`].includes(this._name)}isSecure(){return this._name===`script-src`?!this._value.includes(`unsafe-inline`)&&!this._value.includes(`unsafe-eval`):this._name===`object-src`?this._value===`'none'`:!0}getSecurityRecommendations(){let e=[];return this._name===`script-src`&&this._value.includes(`unsafe-inline`)&&e.push(`Avoid unsafe-inline in script-src for better security`),this._name===`script-src`&&this._value.includes(`unsafe-eval`)&&e.push(`Avoid unsafe-eval in script-src for better security`),this._name===`object-src`&&this._value!==`'none'`&&e.push(`Consider setting object-src to none`),e}toString(){return`${this._name} ${this._value}`.trim()}},a=class{isEnabled=!1;endpoint=null;eventHandler=null;violations=[];constructor(e){this.repository=e}repository;async startMonitoring(e){return this.endpoint=e,this.initializeSecurityMonitoring(),this.violations}async stopMonitoring(){this.eventHandler&&=(document.removeEventListener(`securitypolicyviolation`,this.eventHandler),null),this.isEnabled=!1}async enableMonitoring(){this.isEnabled=!0}async disableMonitoring(){this.isEnabled=!1}async getStatus(){return{enabled:this.isEnabled,endpoint:this.endpoint?.value||``}}async analyzeDirectives(e){let t=[],r=[];e.forEach(e=>{let n=e.getSecurityRecommendations();r.push(...n),e.isSecure()||t.push(`Insecure directive: ${e.toString()}`)});let i=t.length===0,a={directives:e.map(e=>({name:e.name,value:e.value,isRequired:e.isRequired()})),isCompliant:i,violations:t,recommendations:r},o=new n(this.generateId(),a);return await this.repository.savePolicy(o),o}async analyzeDomains(e){let t=[];return e.forEach(e=>{this.isSuspiciousDomain(e)&&t.push(e)}),{suspiciousDomains:t,isSecure:t.length===0}}initializeSecurityMonitoring(){this.eventHandler&&document.removeEventListener(`securitypolicyviolation`,this.eventHandler),this.eventHandler=this.handleSecurityPolicyViolation.bind(this),document.addEventListener(`securitypolicyviolation`,this.eventHandler)}async handleSecurityPolicyViolation(e){let n=e,r={blockedUri:n.blockedURI||``,documentUri:n.documentURI||``,effectiveDirective:n.effectiveDirective||``,originalPolicy:n.originalPolicy||``,referrer:n.referrer||``,scriptSample:n.sample||``,statusCode:n.statusCode||0,violatedDirective:n.violatedDirective||``},i=new t(this.generateId(),r,new Date,navigator.userAgent,window.location.href,{lineNumber:n.lineNumber,columnNumber:n.columnNumber,sourceFile:n.sourceFile});this.violations.push(i),await this.repository.save(i),this.isEnabled&&this.endpoint&&await this.sendReportToEndpoint(i)}async sendReportToEndpoint(e){if(!this.endpoint)return console.log(`📤 CSP Sentinel: No endpoint configurado, saltando envío de reporte`),!1;try{let t={type:`csp-violation`,timestamp:e.timestamp.toISOString(),userAgent:e.userAgent,url:e.url,violation:e.violationData,additionalInfo:e.additionalInfo};console.log(`📤 CSP Sentinel: Enviando reporte de violación al endpoint ${this.endpoint.value}`,t);let n=await fetch(this.endpoint.value,{method:`POST`,headers:{"Content-Type":`application/json`},body:JSON.stringify(t)});return n.ok?(console.log(`✅ CSP Sentinel: Reporte enviado exitosamente`),!0):(console.error(`❌ CSP Sentinel: Error al enviar reporte: ${n.status}`),!1)}catch(e){return console.error(`❌ CSP Sentinel: Error al enviar reporte:`,e),!1}}isSuspiciousDomain(e){return[`malicious`,`evil`,`hack`,`phish`,`scam`,`fake`,`suspicious`].some(t=>e.toLowerCase().includes(t))}generateId(){return`csp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}},o=class{violations=new Map;policies=new Map;async findById(e){return this.violations.get(e)||null}async save(e){this.violations.set(e.id,e)}async delete(e){this.violations.delete(e)}async findPolicies(){return Array.from(this.policies.values())}async findViolationsByDirective(e){return Array.from(this.violations.values()).filter(t=>t.violationData.violatedDirective.includes(e))}async findHighRiskViolations(){return Array.from(this.violations.values()).filter(e=>e.isHighRisk())}async savePolicy(e){this.policies.set(e.id,e)}async findViolationsByTimeRange(e,t){return Array.from(this.violations.values()).filter(n=>n.timestamp>=e&&n.timestamp<=t)}},s=class{constructor(e){this.cspMonitoringService=e}cspMonitoringService;async execute(e){try{let t=new r(e||`/csp-violations`),n=await this.cspMonitoringService.startMonitoring(t);return await this.cspMonitoringService.enableMonitoring(),console.log(`🔒 CSP Sentinel: Monitoreo iniciado en endpoint ${t.value}`),{success:!0,data:{endpoint:t.value,violations:n.length,isEnabled:!0},message:`CSP violation monitoring started successfully`}}catch(e){return console.error(`❌ CSP Sentinel: Error al iniciar monitoreo:`,e),{success:!1,error:e,message:`Failed to start CSP violation monitoring`}}}},c=class{constructor(e){this.cspMonitoringService=e}cspMonitoringService;async execute(e,t){try{let n=[];n=e&&e.length>0?e.map(e=>{let[t,...n]=e.split(` `);return new i(t,n.join(` `))}):t?this.parsePolicyString(t):this.getCurrentPageDirectives();let r=await this.cspMonitoringService.analyzeDirectives(n);return{success:!0,data:{isCompliant:r.policyData.isCompliant,violations:r.policyData.violations,recommendations:r.policyData.recommendations,securityScore:r.getSecurityScore(),directives:r.policyData.directives},message:`CSP directives analysis completed`}}catch(e){return{success:!1,error:e,message:`Failed to analyze CSP directives`}}}parsePolicyString(e){let t=[];return e.split(`;`).filter(e=>e.trim()).forEach(e=>{let[n,...r]=e.trim().split(` `);n&&t.push(new i(n,r.join(` `)))}),t}getCurrentPageDirectives(){let e=document.querySelector(`meta[http-equiv="Content-Security-Policy"]`);if(e){let t=e.getAttribute(`content`);if(t)return this.parsePolicyString(t)}return[new i(`default-src`,`'self'`),new i(`script-src`,`'self' 'unsafe-inline'`),new i(`style-src`,`'self' 'unsafe-inline'`),new i(`img-src`,`'self' data:`)]}},l=class{type=`monitor-violations`;params;constructor(e){this.params=e}async execute(){throw Error(`Command execution should be handled by MonitorViolationsCommandHandler`)}},u=class{constructor(e){this.monitorViolationsUseCase=e}monitorViolationsUseCase;canHandle(e){return e.type===`monitor-violations`}async handle(e){let t=await this.monitorViolationsUseCase.execute(e.params.endpoint);return{success:t.success,data:t.data,message:t.message,error:t.error}}},d=class{type=`analyze-directives`;params;constructor(e){this.params=e}async execute(){throw Error(`Command execution should be handled by AnalyzeDirectivesCommandHandler`)}},f=class{constructor(e){this.analyzeDirectivesUseCase=e}analyzeDirectivesUseCase;canHandle(e){return e.type===`analyze-directives`}async handle(e){let t=await this.analyzeDirectivesUseCase.execute(e.params.directives,e.params.policy);return{success:t.success,data:t.data,message:t.message,error:t.error}}},ee=class{type=`analyze-domains`;params;constructor(e){this.params=e}async execute(){throw Error(`Command execution should be handled by AnalyzeDomainsCommandHandler`)}},te=class{constructor(){}canHandle(e){return e.type===`analyze-domains`}async handle(e){let t=e.params.domains||[],n=[];return t.forEach(e=>{this.isSuspiciousDomain(e)&&n.push(e)}),{success:!0,data:{domains:t,suspiciousDomains:n,isSecure:n.length===0,recommendations:n.length>0?[`Consider blocking suspicious domains in your CSP policy`]:[`All domains appear to be secure`]},message:`Domain analysis completed`}}isSuspiciousDomain(e){return[`malicious`,`evil`,`hack`,`phish`,`scam`,`fake`,`suspicious`].some(t=>e.toLowerCase().includes(t))}},ne=class{type=`enable-monitoring`;params;constructor(e={}){this.params=e}async execute(){throw Error(`Command execution should be handled by EnableMonitoringCommandHandler`)}},re=class{constructor(){}canHandle(e){return e.type===`enable-monitoring`}async handle(e){return{success:!0,data:{enabled:!0},message:`CSP monitoring enabled successfully`}}},ie=class{type=`disable-monitoring`;params;constructor(e={}){this.params=e}async execute(){throw Error(`Command execution should be handled by DisableMonitoringCommandHandler`)}},p=class{constructor(){}canHandle(e){return e.type===`disable-monitoring`}async handle(e){return{success:!0,data:{enabled:!1},message:`CSP monitoring disabled successfully`}}},m=class{type=`get-status`;params;constructor(e={}){this.params=e}async execute(){throw Error(`Command execution should be handled by GetStatusCommandHandler`)}},h=class{constructor(){}canHandle(e){return e.type===`get-status`}async handle(e){return{success:!0,data:{enabled:!0,endpoint:`/csp-violations`,lastCheck:new Date().toISOString(),version:`1.0.0`},message:`CSP Sentinel status retrieved successfully`}}},g=class{handlers=new Map;isInitialized=!1;monitorViolationsCommandHandler;analyzeDirectivesCommandHandler;analyzeDomainsCommandHandler;enableMonitoringCommandHandler;disableMonitoringCommandHandler;getStatusCommandHandler;constructor(e,t,n,r,i,a){this.monitorViolationsCommandHandler=e,this.analyzeDirectivesCommandHandler=t,this.analyzeDomainsCommandHandler=n,this.enableMonitoringCommandHandler=r,this.disableMonitoringCommandHandler=i,this.getStatusCommandHandler=a,this.initializeHandlers()}initializeHandlers(){this.registerHandler(this.monitorViolationsCommandHandler),this.registerHandler(this.analyzeDirectivesCommandHandler),this.registerHandler(this.analyzeDomainsCommandHandler),this.registerHandler(this.enableMonitoringCommandHandler),this.registerHandler(this.disableMonitoringCommandHandler),this.registerHandler(this.getStatusCommandHandler),this.isInitialized=!0,console.log(`🛡️ CSP Command Executor Service initialized with`,this.handlers.size,`handlers`)}async execute(e){if(!this.isInitialized)return{success:!1,error:Error(`CSP Command Executor Service not initialized`),message:`CSP Command Executor Service not initialized`};let t=this.findHandler(e);if(!t)return{success:!1,error:Error(`No handler found for command type: ${e.type}`),message:`No handler found for command type: ${e.type}`};try{return await t.handle(e)}catch(t){return{success:!1,error:t,message:`Error executing command: ${e.type}`}}}registerHandler(e){let t=this.extractCommandTypeFromHandler(e);this.handlers.set(t,e)}unregisterHandler(e){this.handlers.delete(e)}getRegisteredHandlers(){return Array.from(this.handlers.keys())}findHandler(e){return this.handlers.get(e.type)}extractCommandTypeFromHandler(e){let t=e.constructor.name;return{MonitorViolationsCommandHandler:`monitor-violations`,AnalyzeDirectivesCommandHandler:`analyze-directives`,AnalyzeDomainsCommandHandler:`analyze-domains`,EnableMonitoringCommandHandler:`enable-monitoring`,DisableMonitoringCommandHandler:`disable-monitoring`,GetStatusCommandHandler:`get-status`}[t]||t.toLowerCase().replace(`handler`,``)}},_=class{createMonitorViolationsCommand(e){return new l(e)}createAnalyzeDirectivesCommand(e){return new d(e)}createAnalyzeDomainsCommand(e){return new ee(e)}createEnableMonitoringCommand(e={}){return new ne(e)}createDisableMonitoringCommand(e={}){return new ie(e)}createGetStatusCommand(e={}){return new m(e)}},v=class e{static instance=null;repository;cspMonitoringService;monitorViolationsUseCase;analyzeDirectivesUseCase;commandExecutor;commandFactory;constructor(){this.repository=new o,this.cspMonitoringService=new a(this.repository),this.monitorViolationsUseCase=new s(this.cspMonitoringService),this.analyzeDirectivesUseCase=new c(this.cspMonitoringService);let e=new u(this.monitorViolationsUseCase),t=new f(this.analyzeDirectivesUseCase),n=new te,r=new re,i=new p,l=new h;this.commandExecutor=new g(e,t,n,r,i,l),this.commandFactory=new _}static getInstance(){return e.instance||=new e,e.instance}getCommandExecutor(){return this.commandExecutor}getCommandFactory(){return this.commandFactory}getMonitorViolationsUseCase(){return this.monitorViolationsUseCase}getAnalyzeDirectivesUseCase(){return this.analyzeDirectivesUseCase}},y=class{adapter=v.getInstance();async startMonitoring(e){let t=this.adapter.getCommandFactory().createMonitorViolationsCommand(e);return this.adapter.getCommandExecutor().execute(t)}async enableMonitoring(){let e=this.adapter.getCommandFactory().createEnableMonitoringCommand({});return this.adapter.getCommandExecutor().execute(e)}async disableMonitoring(){let e=this.adapter.getCommandFactory().createDisableMonitoringCommand({});return this.adapter.getCommandExecutor().execute(e)}async analyzeDirectives(e={}){let t=this.adapter.getCommandFactory().createAnalyzeDirectivesCommand(e);return this.adapter.getCommandExecutor().execute(t)}async analyzeDomains(e={}){let t=this.adapter.getCommandFactory().createAnalyzeDomainsCommand(e);return this.adapter.getCommandExecutor().execute(t)}async getStatus(){let e=this.adapter.getCommandFactory().createGetStatusCommand({});return this.adapter.getCommandExecutor().execute(e)}async runFullAnalysis(e={}){let t=await Promise.allSettled([this.analyzeDirectives({directives:e.directives}),this.analyzeDomains({domains:e.domains}),this.getStatus()]);return{success:!0,data:{directives:t[0].status===`fulfilled`?t[0].value:null,domains:t[1].status===`fulfilled`?t[1].value:null,status:t[2].status===`fulfilled`?t[2].value:null,errors:t.filter(e=>e.status===`rejected`).map(e=>e.reason)},message:`CSP analysis completed`}}},b=null;function x(){return b||=new y,b}async function S(e){let t=x();return await t.startMonitoring({endpoint:e.endpoint}),e.enableMonitoring&&await t.enableMonitoring(),e.runAnalysis&&await t.runFullAnalysis({directives:e.directives,domains:e.domains}),t}var C=class e{id;selector;elementData;found;detectedAt;constructor(e,t,n,r,i=new Date){this.id=e,this.selector=t,this.elementData=n,this.found=r,this.detectedAt=i}equals(t){return t instanceof e?this.id===t.id:!1}isSuspicious(){return this.found}getElementInfo(){return!this.found||!this.elementData?`Element not found for selector: ${this.selector}`:`Found ${this.elementData.tagName} with id="${this.elementData.id}" and class="${this.elementData.className}"`}},w=class e{id;iframeData;found;detectedAt;constructor(e,t,n,r=new Date){this.id=e,this.iframeData=t,this.found=n,this.detectedAt=r}equals(t){return t instanceof e?this.id===t.id:!1}isSuspicious(){return!this.found||!this.iframeData?!1:!this.iframeData.sandbox||this.iframeData.src.includes(`javascript:`)||this.iframeData.src.startsWith(`data:`)}getSecurityInfo(){return!this.found||!this.iframeData?`No iframes detected`:`Iframe found with src="${this.iframeData.src}" and sandbox="${this.iframeData.sandbox}"`}},T=class e{id;scriptData;suspiciousDomains;detectedAt;constructor(e,t,n,r=new Date){this.id=e,this.scriptData=t,this.suspiciousDomains=n,this.detectedAt=r}equals(t){return t instanceof e?this.id===t.id:!1}isSuspicious(){return this.scriptData.src?this.suspiciousDomains.some(e=>this.scriptData.src.includes(e)):!1}getSuspiciousReason(){return this.isSuspicious()?`Script loaded from suspicious domain(s): ${this.suspiciousDomains.filter(e=>this.scriptData.src.includes(e)).join(`, `)}`:`Script is not suspicious`}},E=class e{_value;constructor(e){if(!e||e.trim().length===0)throw Error(`Selector cannot be empty`);this._value=e.trim()}get value(){return this._value}equals(t){return t instanceof e?this._value===t._value:!1}isValid(){try{return document.querySelector(this._value),!0}catch{return!1}}toString(){return this._value}},D=class e{_value;constructor(e){if(!e||e.trim().length===0)throw Error(`Domain cannot be empty`);let t=e.trim();if(!this.isValidDomain(t))throw Error(`Invalid domain format: ${t}`);this._value=t}get value(){return this._value}equals(t){return t instanceof e?this._value===t._value:!1}isValidDomain(e){return/^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?)*$/.test(e)}isSuspicious(e){return e.some(e=>this._value.includes(e)||e.includes(this._value))}toString(){return this._value}},O=class{constructor(e){this.repository=e}repository;endpoint=null;setEndpoint(e){this.endpoint=e}async detectElement(e){console.log(`🔍 DOM Sentinel: Buscando elemento con selector "${e.value}"`);let t=document.querySelector(e.value),n=t!==null,r=null;n&&t?(r={tagName:t.tagName,className:t.className,id:t.id,attributes:this.getElementAttributes(t)},console.log(`✅ DOM Sentinel: Elemento encontrado`,r)):console.log(`❌ DOM Sentinel: Elemento no encontrado para selector "${e.value}"`);let i=new C(this.generateId(),e.value,r,n);return await this.repository.save(i),n&&await this.sendDetectionReport(`element`,{selector:e.value,element:r,timestamp:new Date().toISOString()}),i}async detectIframe(){console.log(`🔍 DOM Sentinel: Buscando iframes en el documento`);let e=document.querySelector(`iframe`),t=e!==null,n=null;t&&e?(n={src:e.src||``,sandbox:e.sandbox?.value||``,allow:e.allow||``,loading:e.loading||``,width:e.width||``,height:e.height||``},console.log(`✅ DOM Sentinel: Iframe encontrado`,n)):console.log(`❌ DOM Sentinel: No se encontraron iframes`);let r=new w(this.generateId(),n,t);return await this.repository.saveIframe(r),t&&await this.sendDetectionReport(`iframe`,{iframe:n,timestamp:new Date().toISOString()}),r}async detectSuspiciousScripts(e){console.log(`🔍 DOM Sentinel: Buscando scripts sospechosos con dominios:`,e.map(e=>e.value));let t=document.querySelectorAll(`script[src]`),n=[],r=e.map(e=>e.value);return t.forEach(e=>{let t=e,i={src:t.src||``,type:t.type||``,async:t.async,defer:t.defer,integrity:t.integrity||``,crossorigin:t.crossOrigin||``},a=new T(this.generateId(),i,r);a.isSuspicious()&&(console.log(`⚠️ DOM Sentinel: Script sospechoso detectado`,i),n.push(a),this.repository.saveSuspiciousScript(a))}),n.length===0?console.log(`✅ DOM Sentinel: No se encontraron scripts sospechosos`):(console.log(`🚨 DOM Sentinel: Se encontraron ${n.length} scripts sospechosos`),await this.sendDetectionReport(`suspicious-scripts`,{scripts:n.map(e=>e.getSuspiciousReason()),count:n.length,timestamp:new Date().toISOString()})),n}async detectLiveElement(e){console.log(`🔍 DOM Sentinel: Iniciando monitoreo en vivo para selector "${e.value}"`);let t=document.querySelector(e.value);if(t){console.log(`✅ DOM Sentinel: Elemento ya existe para selector "${e.value}"`);let n={tagName:t.tagName,className:t.className,id:t.id,attributes:this.getElementAttributes(t)},r=new C(this.generateId(),e.value,n,!0);return this.repository.save(r),await this.sendDetectionReport(`live-element`,{selector:e.value,element:n,timestamp:new Date().toISOString()}),r}return new Promise(t=>{new MutationObserver(n=>{n.forEach(n=>{if(n.type===`childList`){let n=document.querySelector(e.value);if(n){console.log(`⚡ DOM Sentinel: Elemento detectado en vivo`,{selector:e.value,tagName:n.tagName,className:n.className});let r={tagName:n.tagName,className:n.className,id:n.id,attributes:this.getElementAttributes(n)},i=new C(this.generateId(),e.value,r,!0);this.repository.save(i),this.sendDetectionReport(`live-element`,{selector:e.value,element:r,timestamp:new Date().toISOString()}),t(i)}}})}).observe(document.body,{childList:!0,subtree:!0}),console.log(`👁️ DOM Sentinel: Monitoreo continuo activado para selector "${e.value}"`)})}getElementAttributes(e){let t={};for(let n=0;n<e.attributes.length;n++){let r=e.attributes[n];t[r.name]=r.value}return t}generateId(){return`dom-shield-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}async sendDetectionReport(e,t){if(!this.endpoint){console.log(`📤 DOM Sentinel: No endpoint configurado, saltando envío de reporte`);return}try{let n={type:`dom-detection`,detectionType:e,data:t,userAgent:navigator.userAgent,url:window.location.href,timestamp:new Date().toISOString()};console.log(`📤 DOM Sentinel: Enviando reporte al endpoint`,n);let r=await fetch(this.endpoint,{method:`POST`,headers:{"Content-Type":`application/json`},body:JSON.stringify(n)});r.ok?console.log(`✅ DOM Sentinel: Reporte enviado exitosamente`):console.error(`❌ DOM Sentinel: Error al enviar reporte: ${r.status}`)}catch(e){console.error(`❌ DOM Sentinel: Error al enviar reporte:`,e)}}},k=class{elements=new Map;iframes=new Map;scripts=new Map;async findById(e){return this.elements.get(e)||null}async save(e){this.elements.set(e.id,e)}async delete(e){this.elements.delete(e)}async findIframes(){return Array.from(this.iframes.values())}async findSuspiciousScripts(){return Array.from(this.scripts.values())}async findBySelector(e){return Array.from(this.elements.values()).filter(t=>t.selector===e)}async saveIframe(e){this.iframes.set(e.id,e)}async saveSuspiciousScript(e){this.scripts.set(e.id,e)}},A=class{constructor(e){this.domDetectionService=e}domDetectionService;async execute(e){try{let t=new E(e),n=await this.domDetectionService.detectElement(t);return{success:!0,data:n,message:n.isSuspicious()?`Suspicious element detected: ${e}`:`Element check completed for selector: ${e}`}}catch(t){return{success:!1,error:t,message:`Failed to detect element: ${e}`}}}},j=class{constructor(e){this.domDetectionService=e}domDetectionService;async execute(){try{let e=await this.domDetectionService.detectIframe();return{success:!0,data:e,message:e.isSuspicious()?`Suspicious iframe detected`:`Iframe check completed`}}catch(e){return{success:!1,error:e,message:`Failed to detect iframe`}}}},M=class{constructor(e){this.domDetectionService=e}domDetectionService;async execute(e){try{let t=e.map(e=>new D(e)),n=await this.domDetectionService.detectSuspiciousScripts(t);return{success:!0,data:n,message:n.length>0?`Found ${n.length} suspicious script(s)`:`No suspicious scripts detected`}}catch(e){return{success:!1,error:e,message:`Failed to detect suspicious scripts`}}}},N=class{constructor(e){this.domDetectionService=e}domDetectionService;async execute(e){try{let t=new E(e),n=await this.domDetectionService.detectLiveElement(t);return{success:!0,data:n,message:n.isSuspicious()?`Live element detected: ${e}`:`Live element check completed for selector: ${e}`}}catch(t){return{success:!1,error:t,message:`Failed to detect live element: ${e}`}}}},P=class{type=`detect-element`;params;constructor(e){this.params=e}async execute(){throw Error(`Command execution should be handled by DetectElementCommandHandler`)}},F=class{constructor(e){this.detectElementUseCase=e}detectElementUseCase;canHandle(e){return e.type===`detect-element`}async handle(e){let t=await this.detectElementUseCase.execute(e.params.selector);return{success:t.success,data:t.data,message:t.message,error:t.error}}},I=class{type=`detect-iframe`;params;constructor(e={}){this.params=e}async execute(){throw Error(`Command execution should be handled by DetectIframeCommandHandler`)}},ae=class{constructor(e){this.detectIframeUseCase=e}detectIframeUseCase;canHandle(e){return e.type===`detect-iframe`}async handle(e){let t=await this.detectIframeUseCase.execute();return{success:t.success,data:t.data,message:t.message,error:t.error}}},L=class{type=`detect-suspicious-scripts`;params;constructor(e){this.params=e}async execute(){throw Error(`Command execution should be handled by DetectSuspiciousScriptsCommandHandler`)}},R=class{constructor(e){this.detectSuspiciousScriptsUseCase=e}detectSuspiciousScriptsUseCase;canHandle(e){return e.type===`detect-suspicious-scripts`}async handle(e){let t=await this.detectSuspiciousScriptsUseCase.execute(e.params.domains);return{success:t.success,data:t.data,message:t.message,error:t.error}}},z=class{type=`detect-live-element`;params;constructor(e){this.params=e}async execute(){throw Error(`Command execution should be handled by DetectLiveElementCommandHandler`)}},B=class{constructor(e){this.detectLiveElementUseCase=e}detectLiveElementUseCase;canHandle(e){return e.type===`detect-live-element`}async handle(e){let t=await this.detectLiveElementUseCase.execute(e.params.selector);return{success:t.success,data:t.data,message:t.message,error:t.error}}},V=class{type=`get-status`;params;constructor(e={}){this.params=e}async execute(){throw Error(`Command execution should be handled by GetStatusCommandHandler`)}},H=class{constructor(){}canHandle(e){return e.type===`get-status`}async handle(e){return{success:!0,data:{enabled:!0,lastCheck:new Date().toISOString(),version:`1.0.0`},message:`DOM Sentinel status retrieved successfully`}}},U=class{handlers=new Map;isInitialized=!1;detectElementCommandHandler;detectIframeCommandHandler;detectSuspiciousScriptsCommandHandler;detectLiveElementCommandHandler;getStatusCommandHandler;constructor(e,t,n,r,i){this.detectElementCommandHandler=e,this.detectIframeCommandHandler=t,this.detectSuspiciousScriptsCommandHandler=n,this.detectLiveElementCommandHandler=r,this.getStatusCommandHandler=i,this.initializeHandlers()}initializeHandlers(){this.registerHandler(this.detectElementCommandHandler),this.registerHandler(this.detectIframeCommandHandler),this.registerHandler(this.detectSuspiciousScriptsCommandHandler),this.registerHandler(this.detectLiveElementCommandHandler),this.registerHandler(this.getStatusCommandHandler),this.isInitialized=!0,console.log(`🛡️ DOM Command Executor Service initialized with`,this.handlers.size,`handlers`)}async execute(e){if(!this.isInitialized)return{success:!1,error:Error(`DOM Command Executor Service not initialized`),message:`DOM Command Executor Service not initialized`};let t=this.findHandler(e);if(!t)return{success:!1,error:Error(`No handler found for command type: ${e.type}`),message:`No handler found for command type: ${e.type}`};try{return await t.handle(e)}catch(t){return{success:!1,error:t,message:`Error executing command: ${e.type}`}}}registerHandler(e){let t=this.extractCommandTypeFromHandler(e);this.handlers.set(t,e)}unregisterHandler(e){this.handlers.delete(e)}getRegisteredHandlers(){return Array.from(this.handlers.keys())}findHandler(e){return this.handlers.get(e.type)}extractCommandTypeFromHandler(e){let t=e.constructor.name;return{DetectElementCommandHandler:`detect-element`,DetectIframeCommandHandler:`detect-iframe`,DetectSuspiciousScriptsCommandHandler:`detect-suspicious-scripts`,DetectLiveElementCommandHandler:`detect-live-element`,GetStatusCommandHandler:`get-status`}[t]||t.toLowerCase().replace(`handler`,``)}},W=class{createDetectElementCommand(e){return new P(e)}createDetectIframeCommand(e={}){return new I(e)}createDetectSuspiciousScriptsCommand(e){return new L(e)}createDetectLiveElementCommand(e){return new z(e)}createGetStatusCommand(e={}){return new V(e)}},G=class e{static instance=null;repository;domDetectionService;detectElementUseCase;detectIframeUseCase;detectSuspiciousScriptsUseCase;detectLiveElementUseCase;commandExecutor;commandFactory;constructor(){this.repository=new k,this.domDetectionService=new O(this.repository),this.detectElementUseCase=new A(this.domDetectionService),this.detectIframeUseCase=new j(this.domDetectionService),this.detectSuspiciousScriptsUseCase=new M(this.domDetectionService),this.detectLiveElementUseCase=new N(this.domDetectionService);let e=new F(this.detectElementUseCase),t=new ae(this.detectIframeUseCase),n=new R(this.detectSuspiciousScriptsUseCase),r=new B(this.detectLiveElementUseCase),i=new H;this.commandExecutor=new U(e,t,n,r,i),this.commandFactory=new W}static getInstance(){return e.instance||=new e,e.instance}getCommandExecutor(){return this.commandExecutor}getCommandFactory(){return this.commandFactory}getDetectElementUseCase(){return this.detectElementUseCase}getDetectIframeUseCase(){return this.detectIframeUseCase}getDetectSuspiciousScriptsUseCase(){return this.detectSuspiciousScriptsUseCase}getDetectLiveElementUseCase(){return this.detectLiveElementUseCase}setEndpoint(e){this.domDetectionService instanceof O&&this.domDetectionService.setEndpoint(e)}},K=class{adapter=G.getInstance();setEndpoint(e){this.adapter.setEndpoint(e)}async detectElement(e){let t=this.adapter.getCommandFactory().createDetectElementCommand(e);return this.adapter.getCommandExecutor().execute(t)}async detectIframe(){let e=this.adapter.getCommandFactory().createDetectIframeCommand({});return this.adapter.getCommandExecutor().execute(e)}async detectSuspiciousScripts(e){let t=this.adapter.getCommandFactory().createDetectSuspiciousScriptsCommand(e);return this.adapter.getCommandExecutor().execute(t)}async detectLiveElement(e){let t=this.adapter.getCommandFactory().createDetectLiveElementCommand(e);return this.adapter.getCommandExecutor().execute(t)}async getStatus(){let e=this.adapter.getCommandFactory().createGetStatusCommand({});return this.adapter.getCommandExecutor().execute(e)}async runFullAnalysis(e={}){let t=[];if(e.selectors)for(let n of e.selectors){let e=await this.detectElement({selector:n});t.push({type:`element`,selector:n,result:e})}let n=await this.detectIframe();if(t.push({type:`iframe`,result:n}),e.suspiciousDomains&&e.suspiciousDomains.length>0){let n=await this.detectSuspiciousScripts({domains:e.suspiciousDomains});t.push({type:`scripts`,domains:e.suspiciousDomains,result:n})}if(e.liveSelectors)for(let n of e.liveSelectors){let e=await this.detectLiveElement({selector:n});t.push({type:`live-element`,selector:n,result:e})}return{success:!0,message:`Full analysis completed`,data:t}}},q=null;function J(){return q||=new K,q}async function oe(e){let t=J();if(e.endpoint&&t.setEndpoint(e.endpoint),await t.runFullAnalysis({selectors:e.selectors,suspiciousDomains:e.suspiciousDomains,liveSelectors:e.liveSelectors}),e.liveSelectors&&e.liveSelectors.length>0){console.log(`👁️ DOM Sentinel: Iniciando monitoreo continuo para ${e.liveSelectors.length} selectores`);for(let n of e.liveSelectors)t.detectLiveElement({selector:n}).catch(e=>{console.error(`❌ DOM Sentinel: Error en monitoreo de selector "${n}":`,e)})}return t}var Y=null,X=null,Z=!1;async function se(e){if(e){if(Y){console.warn(`⚠️ CSP Sentinel instance already exists. Using existing instance.`);return}try{Y=await S({endpoint:e.endpoint,enableMonitoring:e.enable,runAnalysis:e.runAnalysis,directives:e.directives,domains:e.domains}),console.log(`✅ CSP Sentinel initialized successfully`)}catch(e){console.error(`❌ Failed to initialize CSP Sentinel:`,e)}}}async function ce(e,t){if(e){if(X){console.warn(`⚠️ DOM Sentinel instance already exists. Using existing instance.`);return}try{let n=t||`/dom-shield-report`;X=await oe({...e,endpoint:n}),console.log(`✅ DOM Sentinel initialized with command-based analysis`)}catch(e){console.error(`❌ Failed to initialize DOM Sentinel:`,e)}}}var Q={async init(e){if(Z){console.warn(`⚠️ DOM Shield already initialized. Skipping re-initialization.`);return}let t=e.csp?.endpoint;e.csp&&await se(e.csp),e.integrity&&await ce(e.integrity,t),Z=!0,console.log(`🛡️ DOM Shield initialized successfully`)},getCSPSentinel(){return Y},getDOMSentinel(){return X},reset(){Y=null,X=null,Z=!1,console.log(`🔄 DOM Shield reset`)},isInitialized(){return Z}},le=Q;let $=()=>X,ue=()=>Y,de=()=>X,fe=Q.init,pe=Q.reset;exports.DOMShield=Q,exports.default=le,exports.getCSPSentinel=ue,exports.getDOMSentinel=de,exports.getDOMShield=$,exports.getInitializationStatus=()=>Z,exports.init=fe,exports.reset=pe});