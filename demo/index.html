<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOM Shield - Demostración</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>🛡️ DOM Shield</h1>
        <p class="subtitle">Sistema completo de seguridad web</p>

        <div class="demo-section">
            <h2>🚀 Funcionalidades de DOM Shield</h2>
            <p>Prueba todas las funcionalidades organizadas por categoría:</p>

            <div class="button-group">
                <h4>🛡️ Seguridad DOM</h4>
                <button onclick="testSpecificRules()">
                    Reglas Específicas <span class="emoji">🔍</span>
                </button>
                <button onclick="addSuspiciousContent()">
                    Añadir Contenido Sospechoso <span class="emoji">⚠️</span>
                </button>
            </div>

            <div class="button-group">
                <h4>🛡️ Monitor CSP</h4>
                <button onclick="checkCSPStatus()">
                    Estado CSP <span class="emoji">📊</span>
                </button>
                <button onclick="triggerInlineScriptViolation()">
                    Script Inline <span class="emoji">📜</span>
                </button>
                <button onclick="triggerExternalScriptViolation()">
                    Script Externo <span class="emoji">🌐</span>
                </button>
                <button onclick="triggerEvalViolation()">
                    Eval() <span class="emoji">⚡</span>
                </button>
                <button onclick="triggerImageViolation()">
                    Imagen Externa <span class="emoji">🖼️</span>
                </button>
                <button onclick="triggerFetchViolation()">
                    Fetch/XMLHttpRequest <span class="emoji">📡</span>
                </button>
                <button onclick="triggerWebSocketViolation()">
                    WebSocket <span class="emoji">🔌</span>
                </button>
            </div>
        </div>

        <div class="version-info">
            <p>DOM Shield v0.0.1 | Construido con ❤️</p>
            <p>🐳 Docker + nginx + TypeScript + Vite</p>
        </div>
    </div>


        <script src="./dom-shield.umd.js"></script>
        <script>
        const integrityRules = [
            { type: "element", selector: ".gemini-box" },
            { type: "iframe" },
            { type: "live-element", selector: ".gemini-box" },
            { type: "scripts", domains: ["suspicious-domain.example"] },
        ];




        function addSuspiciousContent() {
            const suspiciousDiv = document.createElement('div');
            suspiciousDiv.className = 'gemini-box';
            suspiciousDiv.textContent = '⚠️ Contenido sospechoso detectado';
            suspiciousDiv.style.cssText = 'background: #ff4444; color: white; padding: 10px; margin: 10px 0; border-radius: 5px; border: 2px solid #cc0000;';
            document.querySelector('.container').appendChild(suspiciousDiv);

            const iframe = document.createElement('iframe');
            iframe.src = 'about:blank';
            iframe.style.cssText = 'width: 100px; height: 50px; border: 2px solid yellow; margin: 10px 0;';
            document.querySelector('.container').appendChild(iframe);
            console.log('%c⚠️ Contenido sospechoso añadido', 'color: #FFA500; font-weight: bold;');
        }



        // Funciones para probar diferentes tipos de violaciones CSP

        function triggerInlineScriptViolation() {
            console.log('%c📜 Probando violación de script inline...', 'color: #FF6B6B; font-weight: bold;');
            const script = document.createElement('script');
            script.innerHTML = 'console.log("Script inline - esto debería violar CSP");';
            document.head.appendChild(script);
        }

        function triggerExternalScriptViolation() {
            console.log('%c🌐 Probando violación de script externo...', 'color: #4ECDC4; font-weight: bold;');
            const externalScript = document.createElement('script');
            externalScript.src = 'https://suspicious-domain.example/malicious.js';
            document.head.appendChild(externalScript);
        }

        function triggerEvalViolation() {
            console.log('%c⚡ Probando violación de eval()...', 'color: #FFD93D; font-weight: bold;');
            try {
                eval('console.log("Eval() - esto debería violar CSP");');
            } catch (e) {
                console.log('Eval bloqueado por CSP:', e.message);
            }
        }

        function triggerImageViolation() {
            console.log('%c🖼️ Probando violación de imagen externa...', 'color: #FFB6C1; font-weight: bold;');
            const img = document.createElement('img');
            img.src = 'https://suspicious-domain.example/malicious-image.jpg';
            img.alt = 'Imagen externa bloqueada';
            img.style.cssText = 'width: 100px; height: 100px; border: 2px solid red;';
            document.querySelector('.container').appendChild(img);
        }

        function triggerFetchViolation() {
            console.log('%c📡 Probando violación de fetch/XMLHttpRequest...', 'color: #87CEEB; font-weight: bold;');
            // Fetch
            fetch('https://suspicious-domain.example/api/data')
                .then(response => response.text())
                .then(data => console.log('Fetch exitoso:', data))
                .catch(error => console.log('Fetch bloqueado por CSP:', error.message));

            // XMLHttpRequest
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://suspicious-domain.example/api/data');
            xhr.onload = () => console.log('XHR exitoso:', xhr.responseText);
            xhr.onerror = () => console.log('XHR bloqueado por CSP');
            xhr.send();
        }

        function triggerWebSocketViolation() {
            console.log('%c🔌 Probando violación de WebSocket...', 'color: #DDA0DD; font-weight: bold;');
            try {
                const ws = new WebSocket('wss://suspicious-domain.example/ws');
                ws.onopen = () => console.log('WebSocket conectado');
                ws.onerror = () => console.log('WebSocket bloqueado por CSP');
            } catch (e) {
                console.log('WebSocket bloqueado por CSP:', e.message);
            }
        }

        function checkCSPStatus() {
            const monitor = DOMShield.getCSPMonitor();
            if (monitor) {
                const status = monitor.getMonitoringStatus();
                console.log('%c📊 Estado del CSP Monitor:', 'color: #1E90FF; font-weight: bold;');
                console.table(status);
                const queuedReports = monitor.getQueuedReports();
                if (queuedReports.length > 0) {
                    console.log('%c📋 Reportes en cola:', 'color: #FFA500; font-weight: bold;');
                    queuedReports.forEach((report, index) => {
                        console.log(`${index + 1}.`, report);
                    });
                } else {
                    console.log('%c📭 No hay reportes en cola', 'color: #28a745;');
                }
            } else {
                console.warn('⚠️ CSP Monitor no está inicializado. Haz clic en "Iniciar CSP Monitor" primero.');
            }
        }

        function testSpecificRules() {
            console.log('%c🔍 Reglas de integridad configuradas:', 'color: #9932CC; font-weight: bold;');
            console.log(integrityRules);
        }

        let liveDetectionActive = false;
        function toggleLiveDetection() {
            if (!liveDetectionActive) {
                DOMShield.setupIntegrity([
                    { type: "live-element", selector: ".gemini-box" }
                ]);
                liveDetectionActive = true;
                document.getElementById('live-detection-btn').innerHTML = 'Detener Vigilancia <span class="emoji">�</span>';
                console.log('%c📡 Vigilancia en tiempo real activada para .gemini-box', 'color: #007bff; font-weight: bold;');
            } else {
                // No hay método para detener, solo informativo
                liveDetectionActive = false;
                document.getElementById('live-detection-btn').innerHTML = 'Iniciar Vigilancia <span class="emoji">�</span>';
                console.log('%c🛑 Vigilancia en tiempo real desactivada', 'color: #DC143C; font-weight: bold;');
            }
        }

        window.addEventListener('DOMContentLoaded', async function() {
            await DOMShield.init({
                csp: { 
                    endpoint: "/csp-violations", 
                    enable: true,
                    maxQueueSize: 100,
                    runAnalysis: true,
                    directives: ["default-src", "script-src", "style-src"],
                    domains: ["trusted.com", "cdn.example.com"]
                },
                integrity: integrityRules
            });
            console.log('%c🌟 ¡Bienvenido a DOM Shield v0.0.1!', 'color: #FF6B6B; font-size: 20px; font-weight: bold;');
        });
        </script>
</body>
</html>
